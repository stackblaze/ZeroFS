syntax = "proto3";

package zerofs.admin;

import "google/protobuf/timestamp.proto";

service AdminService {
    rpc CreateCheckpoint(CreateCheckpointRequest) returns (CreateCheckpointResponse);

    rpc ListCheckpoints(ListCheckpointsRequest) returns (ListCheckpointsResponse);

    rpc DeleteCheckpoint(DeleteCheckpointRequest) returns (DeleteCheckpointResponse);

    rpc GetCheckpointInfo(GetCheckpointInfoRequest) returns (GetCheckpointInfoResponse);

    rpc WatchFileAccess(WatchFileAccessRequest) returns (stream FileAccessEvent);

    // Dataset operations
    rpc CreateDataset(CreateDatasetRequest) returns (CreateDatasetResponse);

    rpc ListDatasets(ListDatasetsRequest) returns (ListDatasetsResponse);

    rpc DeleteDataset(DeleteDatasetRequest) returns (DeleteDatasetResponse);

    rpc GetDatasetInfo(GetDatasetInfoRequest) returns (GetDatasetInfoResponse);

    rpc SetDefaultDataset(SetDefaultDatasetRequest) returns (SetDefaultDatasetResponse);

    rpc GetDefaultDataset(GetDefaultDatasetRequest) returns (GetDefaultDatasetResponse);

    // Snapshot operations
    rpc CreateSnapshot(CreateSnapshotRequest) returns (CreateSnapshotResponse);

    rpc ListSnapshots(ListSnapshotsRequest) returns (ListSnapshotsResponse);

    rpc DeleteSnapshot(DeleteSnapshotRequest) returns (DeleteSnapshotResponse);
    
    // Snapshot file operations
    rpc ReadSnapshotFile(ReadSnapshotFileRequest) returns (stream FileChunk);
    
    // Instant restore (COW - creates directory entry pointing to snapshot inode)
    rpc InstantRestoreFile(InstantRestoreFileRequest) returns (InstantRestoreFileResponse);
    
    // Clone a file or directory using COW (Copy-on-Write)
    rpc ClonePath(ClonePathRequest) returns (ClonePathResponse);
}

message CheckpointInfo {
    // UUID as string
    string id = 1;
    string name = 2;
    google.protobuf.Timestamp created_at = 3;
}

message CreateCheckpointRequest {
    string name = 1;
}

message CreateCheckpointResponse {
    CheckpointInfo checkpoint = 1;
}

message ListCheckpointsRequest {}

message ListCheckpointsResponse {
    repeated CheckpointInfo checkpoints = 1;
}

message DeleteCheckpointRequest {
    string name = 1;
}

message DeleteCheckpointResponse {}

message GetCheckpointInfoRequest {
    string name = 1;
}

message GetCheckpointInfoResponse {
    CheckpointInfo checkpoint = 1;
}

message WatchFileAccessRequest {}

message FileAccessEvent {
    google.protobuf.Timestamp timestamp = 1;
    FileOperation operation = 2;
    string path = 3;
    OperationParams params = 4;
}

enum FileOperation {
    READ = 0;
    WRITE = 1;
    CREATE = 2;
    REMOVE = 3;
    RENAME = 4;
    MKDIR = 5;
    READDIR = 6;
    LOOKUP = 7;
    SETATTR = 8;
    LINK = 9;
    SYMLINK = 10;
    MKNOD = 11;
    TRIM = 12;
}

message OperationParams {
    optional uint64 offset = 1;
    optional uint64 length = 2;
    optional uint32 mode = 3;
    optional string new_path = 4;
    optional string link_target = 5;
    optional string filename = 6;
}

// Dataset messages
message DatasetInfo {
    uint64 id = 1;
    string name = 2;
    string uuid = 3;
    optional uint64 parent_id = 4;
    optional string parent_uuid = 5;
    uint64 root_inode = 6;
    uint64 created_at = 7;
    bool is_readonly = 8;
    bool is_snapshot = 9;
    uint64 generation = 10;
    uint64 flags = 11;
}

message CreateDatasetRequest {
    string name = 1;
}

message CreateDatasetResponse {
    DatasetInfo dataset = 1;
}

message ListDatasetsRequest {}

message ListDatasetsResponse {
    repeated DatasetInfo datasets = 1;
}

message DeleteDatasetRequest {
    string name = 1;
}

message DeleteDatasetResponse {}

message GetDatasetInfoRequest {
    string name = 1;
}

message GetDatasetInfoResponse {
    DatasetInfo dataset = 1;
}

message SetDefaultDatasetRequest {
    string name = 1;
}

message SetDefaultDatasetResponse {}

message GetDefaultDatasetRequest {}

message GetDefaultDatasetResponse {
    uint64 dataset_id = 1;
}

// Snapshot messages
message CreateSnapshotRequest {
    string source_name = 1;
    string snapshot_name = 2;
    optional bool readonly = 3; // If true, create read-only snapshot. Defaults to false (read-write, like btrfs)
}

message CreateSnapshotResponse {
    DatasetInfo snapshot = 1;
}

message ListSnapshotsRequest {}

message ListSnapshotsResponse {
    repeated DatasetInfo snapshots = 1;
}

message DeleteSnapshotRequest {
    string name = 1;
}

message DeleteSnapshotResponse {}

// Snapshot file reading
message ReadSnapshotFileRequest {
    string snapshot_name = 1;
    string file_path = 2;  // Path within snapshot (e.g., /mnt/my-volume/file.txt)
}

message FileChunk {
    bytes data = 1;
    uint64 offset = 2;
    uint64 total_size = 3;
}

// Instant restore request (COW - no data copying)
message InstantRestoreFileRequest {
    string snapshot_name = 1;
    string source_path = 2;      // Path within snapshot (e.g., /file.txt)
    string destination_path = 3; // Destination path in root filesystem (e.g., /restored-file.txt)
}

message InstantRestoreFileResponse {
    uint64 inode_id = 1;         // Inode ID of restored file (same as snapshot file)
    uint64 file_size = 2;        // File size
    uint32 nlink = 3;            // Link count (should be 2+ after restore)
}

message ClonePathRequest {
    string source_path = 1;      // Source path within ZeroFS (e.g., /mydir)
    string destination_path = 2; // Destination path within ZeroFS (e.g., /mydir-copy)
}

message ClonePathResponse {
    uint64 inode_id = 1;         // Inode ID of cloned file/directory
    uint64 size = 2;             // Size (for files) or 0 (for directories)
    bool is_directory = 3;       // True if cloned item is a directory
}
